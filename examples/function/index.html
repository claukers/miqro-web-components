<!DOCTYPE html>
<html>
<body>
<root-component>
</root-component>
<script type="module">
  import {defineFunction, Store, setLogLevel} from "./lib/index.js";
  setLogLevel("trace");

  defineFunction("external-component", function () {
    const [count, setCount] = this.useState(0);
    return {
      template: "<!--{external.html}-->",
      values: {
        text: "count " + count,
        click: function (ev) {
          ev.preventDefault();
          setCount(count + 1);
        }
      }
    }
  });

  defineFunction("root-component", function () {
    console.log("root-component");
    const [showChildren, setShowChildren] = this.useState(true);
    const [initialCount, setInitialCount] = this.useState(0);
    const [limit] = this.useQuery("limit", 0);
    //console.log("showChildren %s", showChildren);
    return {
      template: `<external-component/><p data-on-click="{toggleShow}">children start</p><div data-if="{showChildren}"><label-fn data-count="{initialCount}"/></div><p data-on-click="{resetCount}">children end {limit}</p><p data-on-click="{add}">add</p><p data-on-click="{subtract}">subtract</p>`,
      values: {
        add: () => {
          store.dispatch({
            type: "add"
          });
        },
        subtract: () => {
          store.dispatch({
            type: "subtract"
          });
        },
        limit,
        showChildren,
        initialCount,
        resetCount: () => {
          setInitialCount(initialCount + 1);
        },
        toggleShow: (ev) => {
          ev.preventDefault();
          setShowChildren(!showChildren);
        }
      }
    }
  });

  const store = new Store({
    subtract: (action, state) => {
      return {
        ...state,
        storeValue: state.storeValue - 1
      };
    },
    add: (action, state) => {
      return {
        ...state,
        storeValue: state.storeValue + 1
      };
    }
  }, {
    storeValue: 1
  });

  defineFunction("label-fn", function () {
    const storeValue = this.useSubscription(store, s => s.storeValue);
    const [initialCount, setInitialCount] = this.useState(0);
    const [count, setCount] = this.useState(0);
    const [limit, setLimit] = this.useQuery("limit", 0);
    const initialCountAttribute = this.useAttribute("data-count", "0");// this.attributes["data-count"].value;

    console.log("label-fn count %s initialCount %s storeValue %s limit %s initialCountAttribute %s", count, initialCount, storeValue, limit, initialCountAttribute);
    if (count === 0) {
      setCount(1);
    }


    this.useEffect(() => {
      console.log("label-fn effect on");
      return () => {
        console.log("label-fn effect off");
      }
    });

    if (initialCount != initialCountAttribute) {
      const newInitialCount = parseInt(initialCountAttribute, 10);
      setCount(newInitialCount);
      setInitialCount(newInitialCount);
    }

    return {
      template: '<p data-on-click="{click}">click count {count}</p><p>initial Count {initialCount}</p><p>limit {limit}</p><p>storeValue {storeValue}</p>',
      values: {
        limit,
        storeValue,
        initialCount,
        count,
        click: function (ev) {
          ev.preventDefault();
          setCount(count + 1);
          setLimit(count + 1);

        }
      }
    }
  });

</script>
</body>
</html>
