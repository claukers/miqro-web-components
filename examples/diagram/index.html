<html>
<body>
<my-root></my-root>
<script type="module">
  import {Component} from "./lib/index.js";

  customElements.define("node-element", class extends Component {

    constructor() {
      super();
      this.state.position = {
        left: parseInt(this.dataset.x, 10) + parseInt(this.dataset.offsetX, 10),
        top: parseInt(this.dataset.y, 10) + parseInt(this.dataset.offsetY, 10)
      };
    }

    static get observedAttributes() {
      return [
        'data-node-name',
        'data-node-y',
        'data-node-x',
        'data-offset-x',
        'data-offset-y'
      ];
    }

    attributeChangedCallback(name, oldValue, newValue) {
      if (name === "data-node-name") {
        this.refresh();
      } else {
        this.setState({
          position: {
            left: parseInt(this.dataset.x, 10) + parseInt(this.dataset.offsetX, 10),
            top: parseInt(this.dataset.y, 10) + parseInt(this.dataset.offsetY, 10)
          }
        });
      }
    }

    mouseDown(ev) {
      ev.preventDefault();
    }

    render() {
      return '<div ' +
        'data-on-mousedown="{this.mouseDown}" ' +
        'style="' +
        'background-color: {this.dataset.color}; ' +
        'position: absolute; ' +
        'left: {this.state.position.left}; ' +
        'top: {this.state.position.top};">node {this.dataset.nodeName} ' +
        '<ul>' +
        '<li>{this.dataset.x},{this.dataset.y}</li>' +
        '<li>{this.dataset.offsetX},{this.dataset.offsetY}</li>' +
        '</ul>' +
        '<span data-if="{this.state.selected}">selected</span></div>';
    }
  });

  customElements.define("my-root", class extends Component {
    constructor() {
      super();
      this.state.offset = {
        gestureOrigin: null,
        x: 0,
        y: 0
      };
      this.state.nodes = [
        {
          name: "A",
          color: "red",
          location: {
            x: 0,
            y: 0
          }
        }
      ];
    }

    mouseDown(ev) {
      ev.preventDefault();
      this.setState({
        gestureOrigin: {
          x: parseInt(ev.clientX, 10),
          y: parseInt(ev.clientY, 10)
        }
      });
    }

    mouseMove(ev) {
      ev.preventDefault();
      if (this.state.gestureOrigin) {
        const offsetX = this.state.offset.x + (this.state.gestureOrigin.x - ev.clientX);
        const offsetY = this.state.offset.y + (this.state.gestureOrigin.y - ev.clientY);
        this.setState({
          gestureOrigin: {
            x: parseInt(ev.clientX, 10),
            y: parseInt(ev.clientY, 10)
          },
          offset: {
            x: offsetX,
            y: offsetY
          }
        })
      }
    }

    mouseUp(ev) {
      ev.preventDefault();
      this.setState({
        gestureOrigin: null
      });
    }

    render() {
      return '<div ' +
        'style="background-color: black; position: absolute; height: 100%; width: 100%; top: 0; left: 0;" ' +
        'data-on-mousedown="{this.mouseDown}" ' +
        'data-on-mouseup="{this.mouseUp}" ' +
        'data-on-mousemove="{this.mouseMove}">' +
        '<node-element ' +
        'data-for-each="{this.state.nodes}" ' +
        'data-node-name="{item.name}" ' +
        'data-node-index="{index}" ' +
        'data-y="{item.location.x}" ' +
        'data-x="{item.location.x}" ' +
        'data-offset-y="{this.state.offset.y}" ' +
        'data-offset-x="{this.state.offset.x}" ' +
        'data-color="{item.color}"/>' +
        '</div>';
    }
  });
</script>
</body>
</html>
