(()=>{"use strict";const t=URLSearchParams.prototype.getAll,e=URLSearchParams.prototype.set,n=URLSearchParams.prototype.append,r=URLSearchParams.prototype.delete,o=MutationObserver.prototype.observe,a=MutationObserver.prototype.disconnect,s=window.dispatchEvent,i=window.addEventListener,c=window.removeEventListener,l=WeakMap.prototype.get,u=WeakMap.prototype.has,f=WeakMap.prototype.set,d=WeakMap.prototype.delete,h=(Map.prototype.keys,Map.prototype.get),p=Map.prototype.set,m=(Map.prototype.delete,"debug"),b="trace",w="warn",g="error",v={trace:0,debug:1,info:2,warn:3,error:4,none:5},y=v.warn;let C=null;function E(t,e,...n){null===C&&(C=y),C<=v[t]&&console["trace"===t?"debug":t](e,...n)}function x(e,n){const r=t.call(new URL(window.location.href).searchParams,e);return 0===r.length?void 0!==n?n:null:r&&1===r.length?r[0]:r}const k=DOMParser.prototype.parseFromString;function A(t){return k.call(new DOMParser,`<root>${t}</root>`,"text/xml")}function N(t,e,n){if(n=void 0!==n?n:void 0,!t||"object"!=typeof t)return void 0!==n?n:void 0;if("string"!=typeof e&&!(e instanceof Array))throw new Error("attrPath must be typeof string or string[]");const r=(e instanceof Array?e:e.split(".")).reverse();if(r.filter((t=>"__prototype__"===t||"__proto__"===t)).length>0)throw new Error("invalid attrPath");let o=t;for(;r.length>0;){const t=r.pop();if(void 0===o[t])return void 0!==n?n:void 0;o=o[t]}return o}function T(t,e){if(null===t&&null!==e||null===e&&null!==t)return!1;if(void 0===t&&void 0!==e||void 0===e&&void 0!==t)return!1;if(null===t&&null===e)return!0;if(void 0===t&&void 0===e)return!0;if(typeof t!=typeof e)return!1;if(t.prototype!==e.prototype||t.__proto__!==e.__proto__)return!1;if(t instanceof Date&&e instanceof Date)return t.getTime()===e.getTime();if("object"==typeof t){const n=Object.keys(t),r=Object.keys(e);if(n.length!==r.length)return!1;for(const r of n)if(t[r]!==e[r]&&!T(t[r],e[r]))return!1}switch(typeof t){case"object":return!0;case"number":case"bigint":case"boolean":case"function":case"symbol":case"string":case"undefined":return t===e}return!0}let S=null;function _(t){return"string"==typeof t?t:`${t.url}`}function M(t,e){S=null!==S?S:new Map;const n=_(t),r={template:e,xmlDocument:A(e)};return p.call(S,n,r),r}function R(t){if(t&&"string"==typeof t&&t.length>3&&"{"===t.charAt(0)&&"}"===t.charAt(t.length-1)){const e=t.substring(1,t.length-1);return e&&-1===e.indexOf(" ")?e:void 0}}const L=/{[^%^{^}^\s]+}/g;function W(t,e){return t.replace(L,(t=>{const n=R(t);return n?function(t,e){if("function"==typeof t){const n=t.bind(e);return String(n())}return void 0!==t?String(t):""}(N(e,n),e.this):t}))}function O(t){t.ref&&(t.parent?function(t,e){if(e instanceof Array)for(const n of e)t.removeChild(n);else t.removeChild(e)}(t.parent,t.ref):t.ref.remove())}function P(t,e){t.splice(e).forEach(O)}function D(t,e){if(e instanceof Array)for(const n of e)t.appendChild(n);else t.appendChild(e)}class ${constructor(t){this.type=t}create(t){throw new Error("not implemented!")}update(t){if(!t)throw new Error("bad ref!");if(this.ref&&this.ref!==t)throw new Error("already created!");return this.ref||(this.ref=t),!1}disconnect(t){}compare(t){return t.type===this.type}toString(){return`${this.type} TemplateNode`}}function V(t,e,n){let r;n=n?[...n]:[],e=e?[...e]:[];let o=!1;for(r=0;r<e.length;r++){const a=e[r],s=n[r];if(void 0===s)o=!0,D(t,a.create(t));else if(s.type!==a.type)o=!0,P(n,r),D(t,a.create(t));else if(a.compare(s)){const t=s.ref,e=s.children;o=!!a.update(t)||o,o=!!V(t,a.children,e)||o}else o=!0,P(n,r),D(t,a.create(t))}return n&&P(n,r),o}class j extends ${constructor(t){super("Text"),this.textContent=t}create(t){if(this.ref)throw new Error("already created!");this.parent=t;const e=document.createTextNode("");return this.update(e),e}update(t){return super.update(t),t.textContent!==this.textContent&&(t.textContent=this.textContent,!0)}}class q extends ${constructor(t){super("HTMLElementRef"),this.ref=t}create(t){return this.parent=t,this.update(this.ref),this.ref}compare(t){return super.compare(t)&&t.ref===this.ref}}function U(t,e){let n=[];if(t.textContent){const r=new j("");let o=r;r.textContent=t.textContent.replace(L,(t=>{const r=R(t);if(r){let t=N(e,r);if("function"==typeof t){const n=t.bind(e.this);t=n()}const a=t instanceof Array&&0===t.filter((t=>!(t instanceof Node))).length;if(a||t instanceof HTMLElement){n.push(o);const e=a?t:[t];return n=n.concat(e.map((t=>new q(t)))),o=new j(""),""}return 0===n.length?String(t):(o.textContent+=String(t),"")}return 0===n.length?t:(o.textContent+=t,"")})),""!==o.textContent&&n.push(o)}return n}const H="data-for-each",J="data-for-each-item",F="data-ref",I="data-on-",Q="data-if",X="data-ifn",z=[F,Q,"data-state",H,J];function B(t,e,n){if("string"==typeof t)return E(b,n?"using cache":"not using cache"),Z((n||A(t)).children[0].childNodes,e)}class G extends ${constructor(t){super("Comment"),this.textContent=t}create(t){if(this.ref)throw new Error("already created!");this.parent=t;const e=document.createComment("");return this.update(e),e}update(t){return super.update(t),t.textContent!==this.textContent&&(t.textContent=this.textContent,!0)}}async function K(t,e){const n=R(t.textContent);if(n){const t=function(t){const e=function(t){const e=_(t);if(S)return h.call(S,e)}(t="string"==typeof t?{url:t}:t);return void 0!==e?e:new Promise(((e,n)=>{try{(async function(t){const e="string"==typeof t,n=e?t:t.url,r=await fetch(n,e?{}:{method:t.method});if(r.status<200||r.status>=300)throw new Error(`bad response status [${r.status}] from [${n}]`);return M(t,await r.text())})(t).then((t=>{e(t)})).catch((e=>{M(t,""),n(e)}))}catch(t){n(t)}}))}(n);if(t instanceof Promise){const n=await t;return B(n.template,e,n.xmlDocument)||[]}return B(t.template,e,t.xmlDocument)||[]}return t.textContent?[new G(t.textContent)]:[]}class Y extends ${constructor(t){super("Element"),this.tagName=t,this.children=[],this.attributes=[],this.listeners=[],this.refListeners=[]}create(t){if(this.ref)throw new Error("already created!");this.parent=t;const e=document.createElement(this.tagName);this.update(e,!0);for(const t of this.refListeners)t.listener(e);if(this.children)for(const t of this.children)try{const n=t.create(e);e.appendChild(n)}catch(t){throw t}return e}update(t,e=!1){super.update(t);let n=!1;for(const e of this.attributes)t.getAttribute(e.attribute)!==e.value&&(n=!0,t.setAttribute(e.attribute,e.value));for(const e of this.listeners)t.addEventListener(e.eventName,e.callback);return n}disconnect(t){for(const e of this.listeners)t.removeEventListener(e.eventName,e.callback);super.disconnect(t)}compare(t){return super.compare(t)&&t.tagName===this.tagName}toString(){return`${this.type} TemplateNode ${this.tagName}`}}async function Z(t,e){let n=[];for(let r=0;r<t.length;r++){const o=t[r];o&&(o.nodeType===Node.COMMENT_NODE&&null!==o.textContent?n=n.concat(await K(o,e)):o.nodeType===Node.TEXT_NODE&&null!==o.textContent?n=n.concat(U(o,e)):o.nodeType===Node.ELEMENT_NODE&&(n=n.concat(await tt(o,e))))}return n}async function tt(t,e){return async function(t,e,n){const r=t.getAttribute(H),o=t.getAttribute(J);if(null!==r){const a=[],s=R(r);let i=s&&N(e,s);if(i="function"==typeof i?i.bind(e.this)():i,s&&i&&i instanceof Array){const r={...e};for(let e=0;e<i.length;e++){r[null!==o?o:"item"]=i[e],r.index=e;const s=await n(t,r);s&&a.push(s)}return a}throw E(g,"invalid value for %s [%s]=[%o] for [%o]",H,r,i,e.this),new Error("invalid value for data-for-each")}{const r=await n(t,e);return r?[r]:[]}}(t,e,(async(t,e)=>{if(function(t,e){const n=t.getAttribute(Q);if(null!==n){const t=R(n);if(!t)throw E(g,"invalid value for %s [%s] for [%o]",Q,n,e.this),new Error("invalid value for data-if");let r=t&&N(e,t);return r="function"==typeof r?r.bind(e.this)():r,!!r}return!0}(t,e)&&function(t,e){const n=t.getAttribute(X);if(null!==n){const t=R(n);if(!t)throw E(g,"invalid value for %s [%s] for [%o]",X,n,e.this),new Error("invalid value for data-ifn");let r=t&&N(e,t);return r="function"==typeof r?r.bind(e.this)():r,!r}return!0}(t,e)){const n=t.tagName,r=new Y(n);return function(t,e,n){const r=t.getAttribute(F);if(null!==r){const t=R(r),o=t?N(e,t):void 0,a=o&&"function"==typeof o?o.bind(e.this):void 0;if(!a)throw E(g,"invalid value for %s [%s]=[%o] for [%o]",F,r,o,e.this),new Error("invalid value for data-ref");n.refListeners.push({listener:a})}}(t,e,r),function(t,e,n){const r=t.getAttributeNames();for(const o of r)if(-1===z.indexOf(o)){const r=t.getAttribute(o);if(r)if(0===o.indexOf(I)){const a=r?o.substring(I.length):void 0,s=r?R(r):void 0,i=s?N(e,s):void 0,c=i&&"function"==typeof i?i.bind(e.this):void 0;if(!c||!a)throw E(g,"invalid value for %s [%s]=[%o][%o] for [%o]",o,r,e,i,t),new Error(`invalid value for ${o}`);n.listeners.push({eventName:a,callback:c})}else n.attributes.push({attribute:o,value:W(r,e)});else n.attributes.push({attribute:o,value:""})}}(t,e,r),r.children=await Z(t.childNodes,e),r}}))}function et(t){const e=l.call(at,t);if(e&&e.timeout){clearTimeout(e.timeout),e.abortController.abort(),e.timeout=null;const n=t instanceof ShadowRoot&&t.host?t.host:t;E(m,"canceling render on %o",n)}}async function nt(t,e,n){if(E(b,"render %o",e),t.signal.aborted)return void E(b,"render aborted %o",e);const r=await n({abortController:t});if(t.signal.aborted)return void E(b,"render aborted %o",e);const o="string"==typeof r?{template:r||"",values:{}}:{template:r&&r.template?r.template:"",values:r&&r.values?r.values:{}};if(o&&void 0!==o.template){const{output:n,xmlDocument:r}=await async function(t,e,n){const r=l.call(rt,t),o=r&&r.template===e?r.xmlDocument:A(e);return{output:await B(e,n,o),xmlDocument:o}}(e,o.template,o.values);return t.signal.aborted?void E(b,"render aborted %o",e):{apply:()=>t.signal.aborted?(E(b,"render aborted %o",e),!1):function(t,e,n,r,o){if(t.signal.aborted)return E(b,"render aborted %o",e),!1;const a=l.call(rt,e);if(o){const t=V(e,o,a?.output);return f.call(rt,e,{output:o,template:n,xmlDocument:r}),a&&ot(a.output),t}return!1}(t,e,o.template,r,n)}}}const rt=new WeakMap;function ot(t){for(const e of t){const t=e.children;e.disconnect(e.ref),t&&ot(t)}}const at=new WeakMap;function st(t,e,n){const r=t.getAttribute(e);return null===r?n:r}function it(t,e,n,r,o,a,s=!0){const i=st(t,o,a);return E(b,"useAttribute %o with value = %o",t,i),s&&-1===n.attributeWatch.indexOf(o)&&(n.attributeWatch.push(o),e.lastValue=i,e.checkChanged=function(){return{shouldAbort:e.lastValue!==st(t,o,a),shouldRefresh:!0}}),i}function ct(t,e,n,r,o,a){const s=it(t,e,n,0,o,a);return E(b,"useJSONAttribute %o with value = %o",t,s),"string"==typeof s&&""!==s?JSON.parse(s):s}function lt(t,e,n,r,o){n.effects.push(o)}function ut(t,e,n,r,o){e.firstRun&&n.mountEffects.push(o)}function ft(t,e){const n=t.splice(0,t.length);for(const t of n)try{const n=t();n&&e.push(n)}catch(t){E(g,t)}}function dt(t){const e=t.splice(0,t.length);for(const t of e)try{t()}catch(t){E(g,t)}}function ht(t,o,a,i,c,l){const u=x(c,l);return-1===a.queryWatch.indexOf(c)&&(a.queryWatch.push(c),o.lastValue=u,o.checkChanged=function(){return{shouldAbort:o.lastValue!==x(c,l),shouldRefresh:!0}}),[u,t=>{!function(t,o){const a=new URL(window.location.href);if(o instanceof Array)for(const e of o)n.call(a.searchParams,t,e);else null!==o?e.call(a.searchParams,t,o):r.call(a.searchParams,t);window.history.pushState(null,"",String(a)),s(new PopStateEvent("popstate"))}(c,t)}]}function pt(t,e,n,r,o){const a=e.name;function s(){return void 0!==n.state[a]?n.state[a]:o}const i=s();return n.state[a]=i,e.lastValue=i,e.checkChanged=function(){return{shouldAbort:e.lastValue!==s(),shouldRefresh:!1}},[i,function(t){n.state[a]!==t&&(r.abortController.abort(),n.state[a]=t,setTimeout((function(){n.refresh()}),0))},s]}function mt(t,e,n,r,o,a){function s(o){E(b,"useSubscription.listener for %s for %s",e.name,t),r.abortController.abort(),setTimeout((function(){n.refresh()}))}const i=o.subscribe(a,s);return this.useEffect((()=>()=>{o.unSubscribe(s)})),e.lastValue=i,e.checkChanged=function(){const n=a(o.getState());return E(b,"useSubscription check for %s for [%s] !== [%s]",e.name,e.lastValue,n),E(b,"useSubscription check for %s for %s",e.name,t),{shouldAbort:!T(e.lastValue,n),shouldRefresh:!1}},i}function bt(t,e,n,r,o,a){e.name=o,function(t,e,n){if("string"!=typeof e&&!(e instanceof Array))throw new Error("attrPath must be typeof string or string[]");const r=(e instanceof Array?e:e.split(".")).reverse();if(r.filter((t=>"__prototype__"===t||"__proto__"===t)).length>0)throw new Error("invalid attrPath");let o=t;for(;r.length>0;){const t=r.pop();0===r.length?o[t]=n:(void 0===o[t]&&(o[t]={}),o=o[t])}}(n.templateValues,o,a)}function wt(t,e,n){return function(t,e,n,r){et(t);const o=Date.now(),a=t instanceof ShadowRoot&&t.host?t.host:t,s=(i=t,u.call(rt,i)?"update":"create");var i;E(b,"queue render %s %o",s,a);const c=l.call(at,t),h=new AbortController,p=c?c.eventTarget:new EventTarget,v=setTimeout((async function(){const n=setTimeout((function(){E(w,"render %s %o max timeout %s",s,a,6e4),h.abort()}),6e4);try{if(E(b,"render %s %o",s,a),h.signal.aborted)return;const i=await nt(h,t,e);if(h.signal.aborted)return;if(i&&i.apply()){const t=Date.now()-o;t>50?E(w,"render %s %o took %sms!",s,a,t):E(m,"render %s %o took %sms",s,a,t)}p.dispatchEvent(new CustomEvent("render",{detail:h.signal}));try{r&&r()}catch(t){E(g,t)}}catch(t){E(g,"error rendering %o %o",a,t)}finally{clearTimeout(n),l.call(at,t)&&d.call(at,t)}}),0);f.call(at,t,{eventTarget:p,abortController:h,timeout:v}),n&&function(t,e){const n=l.call(at,t);n&&n.eventTarget.addEventListener("render",e)}(t,n)}(n.shadowRoot?n.shadowRoot:t,function(t,e,n){return async function(r){if(r.abortController.signal.aborted)return;n.templateChildren=n.templateChildren?n.templateChildren:function(t){const e=[];if(t)for(let n=0;n<t.length;n++)e.push(t[n]);return e}(t.childNodes);const o={children:n.templateChildren},a=function(t,e,n,r){let o=!1;const a=[],s={element:t,shadowRoot:e.shadowRoot};function i(i,c){const l=c.bind(s);if(s[i])throw new Error("already bound");s[i]=function(...s){if(o)throw new Error(`cannot use ${i} after render!`);if(r.abortController.signal.aborted)throw new Error(`cannot use ${i} after render aborted!`);const c={call:i,name:`func-${i}-${a.length}`,firstRun:n};return a.push(c),l(t,c,e,r,...s)}}return i("useState",pt),i("useEffect",lt),i("useMountEffect",ut),i("useAs",bt),i("useAttribute",it),i("useJSONAttribute",ct),i("useQuery",ht),i("useSubscription",mt),{validateAndLock:function(){if(o)throw new Error("cannot use validateAndLock when locked!");o=!0;const t=a.splice(0,a.length);if(n)e.contextCalls=t;else{if(t.length!==e.contextCalls.length)throw e.lock=!0,new Error(`conditional this.use calls detected(1)! ${t.map((t=>t.name)).join(",")} vs ${e.contextCalls.map((t=>t.name)).join(",")}`);if(t.filter(((t,n)=>e.contextCalls[n].call!==t.call||e.contextCalls[n].name!==t.name)).length>0)throw e.lock=!0,new Error("conditional this.use calls detected(2)!");e.contextCalls=t}},this:s}}(t,n,e,r),s=await n.func.bind({...a.this})(r);if(a.validateAndLock(),r.abortController.signal.aborted)return;if(function(t,e,n){let r=!1,o=!0;for(const n of e.contextCalls)if(n.checkChanged){const e=n.checkChanged();if(r=r||e.shouldAbort,r&&o&&e.shouldAbort&&!e.shouldRefresh){o=!1,E(m,"render aborted before apply for %o shouldRefresh %s because %s",t,o,n.name);break}}r&&(E(m,"render aborted before apply for %o shouldRefresh %s",t,o),n.abortController.abort(),o&&setTimeout((function(){e.refresh()}),0))}(t,n,r),r.abortController.signal.aborted)return;const i={...o,...n.templateValues,...s&&"string"!=typeof s&&s.values?s.values:{}};return n.templateValues={},s?"string"==typeof s?{template:s,values:i}:{template:s.template,values:i}:n.template?{template:n.template,values:i}:void 0}}(t,e,n),e?function(){ft(n.mountEffects,n.mountEffectCallbacks)}:void 0,n.renderCallback)}const gt=new WeakMap;function vt(t){const e=l.call(gt,t);if(!e)throw new Error("getMeta no meta for element");return e}const yt={shadowInit:{mode:"closed"},template:""};EventTarget,function(t,e,n){const r=e,s=n?{...yt,...n}:yt;customElements.define("my-component",class extends HTMLElement{constructor(){super(),function(t,e,n,r){if(u.call(gt,t))throw new Error("createHookContext called twice on element");const s={lock:!1,shadowRoot:n||void 0===n?t.attachShadow(n&&"object"==typeof n?n:{mode:"closed"}):void 0,func:e,template:r,state:{},mountEffects:[],mountEffectCallbacks:[],effects:[],effectCallbacks:[],queryWatch:[],attributeWatch:[],contextCalls:[],templateValues:{},observer:new MutationObserver((function(){s.refresh()})),refresh:(e=!1)=>{if(s.lock)throw new Error("conditional this.use calls detected. function component locked!");return dt(s.effectCallbacks),s.attributeWatch.splice(0,s.attributeWatch.length),s.queryWatch.splice(0,s.queryWatch.length),wt(t,e,s)},renderCallback:()=>{s.queryWatch.length>0&&s.effects.unshift(function(t){return function(){const e=t.contextCalls.filter((t=>"useQuery"===t.call));function n(){let n=!1;for(const t of e)if(t.checkChanged&&t.checkChanged()){n=!0;break}n&&t.refresh()}return i("popstate",n),function(){c("popstate",n)}}}(s)),s.attributeWatch.length>0&&s.effects.unshift(function(t,e){return function(){return o.call(e.observer,t,{attributes:!0,attributeFilter:e.attributeWatch}),()=>{a.call(e.observer)}}}(t,s)),ft(s.effects,s.effectCallbacks)}};f.call(gt,t,s)}(this,r,s.shadowInit,s.template)}connectedCallback(){return vt(this).refresh(!0)}disconnectedCallback(){return function(t){const e=vt(t);return dt(e.effectCallbacks),dt(e.mountEffectCallbacks),function(t){et(t);const e=l.call(rt,t);e&&ot(e.output)}(e.shadowRoot?e.shadowRoot:t)}(this)}})}(0,(function(){this.useAs('te"xt',"helloWorld")}),{template:'<p>{text}</p><p>label</p><div><p>"{text}\\"</p>\n<p>label</p></div>'})})();