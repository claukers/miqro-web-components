<html>
<body>
<style>
  body {
    background-color: black;
    color: white;
  }
</style>
<my-root></my-root>
<script type="module">
  import {defineFunction, render as renderTemplate, dispose, set, get} from "./lib/index.js";

  defineFunction("label-fn", function (component) {
    const [count, setCount] = component.useState(0);

    return {
      template: `<p data-on-click="{click}">{count}</p>`,
      values: {
        count,
        click: () => {
          setCount(count + 1);
        }
      }
    }
  })

  const weakMapGet = WeakMap.prototype.get;
  const weakMapSet = WeakMap.prototype.set;
  const weakMapDelete = WeakMap.prototype.delete;
  const attachShadow = HTMLElement.prototype.attachShadow;

  const shadowMap = new WeakMap();

  const metaMap = new WeakMap();

  class ComponentState {
    constructor(defaultValue) {
      this.state = defaultValue ? defaultValue : {};
      this.stateAutoInc = 0;
    }
  }

  function useState(component, defaultValue) {
    const meta = weakMapGet.call(metaMap, component) ? weakMapGet.call(metaMap, component) : new ComponentState();
    const path = `STATE-${meta.stateAutoInc++}`;
    set(meta.state, path, get(meta.state, path, defaultValue));
    weakMapSet.call(metaMap, component, meta);
    return [{
      toString: () => get(meta.state, path, defaultValue),
      value: () => get(meta.state, path, defaultValue)
    }, (newValue) => {
      set(meta.state, path, newValue);
    }];
  }

  function disposeState(component) {
    weakMapDelete.call(metaMap, component);
  }

  customElements.define("my-root", class extends HTMLElement {
    constructor() {
      super();
      const shadowRoot = attachShadow.call(this, {
        mode: "closed"
      });
      weakMapSet.call(shadowMap, this, {shadowRoot});

      const [text] = useState(shadowRoot, "text");
      const [count, setCount] = useState(shadowRoot, 0);
      const [showButton, setShowButton] = useState(shadowRoot, true);

      const render = () => {
        renderTemplate(
          shadowRoot,
          '<label-fn/><p>hello</p><p>{text}</p><!--{template.html}--><button data-if="{showButton}" data-on-click="{click}">clicked {count}</button>',
          {
            text: count.value(),
            count: count.value(),
            showButton: showButton.value(),
            click: () => {
              setCount(count + 1);
              if (count.value() === 10) {
                setShowButton(false);
              }
              render();
            }
          }
        );
      }
      render();
    }

    disconnectedCallback() {
      const {shadowRoot} = weakMapGet.call(shadowMap, this);
      dispose(shadowRoot);
      disposeState(shadowRoot);
    }
  });
</script>
</body>
</html>
